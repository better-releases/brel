# brel

`brel` is a CLI that scaffolds and runs the better-releases workflow.

## Commands

- `brel init` generates a managed GitHub Actions workflow.
- `brel release-pr` computes the next version, updates configured files, commits, pushes, and creates/updates a release PR.

## `release-pr` Prerequisites

- `git` must be available.
- `gh` (GitHub CLI) must be available.
- A GitHub token must be present in `GH_TOKEN` or `GITHUB_TOKEN`.
  - The workflow generated by `brel init` sets `GH_TOKEN: ${{ github.token }}` automatically.

## Config File

`brel` discovers config in this order:

1. `--config <path>` (when provided)
2. `brel.toml`
3. `.brel.toml`

### Minimal `release-pr` config

```toml
provider = "github"
default_branch = "main"

[release_pr.version_updates]
"package.json" = ["version"]
```

### Full `release_pr` config

```toml
[release_pr.version_updates]
"package.json" = ["version"]
"Cargo.toml" = ["package.version"]

[release_pr.format_overrides]
"Cargo.toml" = "toml"

[release_pr]
release_branch_pattern = "brel/release/v{{version}}"
pr_template_file = ".github/brel/release-pr-body.hbs"

[release_pr.commit_author]
name = "brel[bot]"
email = "brel[bot]@users.noreply.github.com"
```

## How Versioning Works

When you run `brel release-pr`:

1. It finds the highest stable SemVer tag (`vX.Y.Z` or `X.Y.Z`).
2. If no valid tag exists, it uses `0.0.0`.
3. It scans commits since that tag (or all commits when no tag exists).
4. It picks one bump level from Conventional Commit signals:
   - major: `BREAKING CHANGE` in body/footer, or `!` in the type/scope prefix.
   - minor: `feat: ...`
   - patch: `fix: ...`
5. If no releasable commits are found, it exits successfully with no changes.

## How File Updates Work

- `release_pr.version_updates` maps exact repo-relative file paths to dot-separated key paths.
- Supported file formats:
  - inferred from extension (`.json`, `.toml`)
  - or forced via `release_pr.format_overrides`
- Updates are fail-fast. The command errors if:
  - a file is missing,
  - format cannot be determined,
  - parse fails,
  - a key path does not exist,
  - target value is not scalar.

Example key paths:

- JSON: `"package.json" = ["version", "tooling.release.version"]`
- TOML: `"Cargo.toml" = ["package.version"]`

## Branch / Commit / PR Behavior

- Default branch pattern: `brel/release/v{{version}}`
  - Only `{{version}}` is supported as a token.
- Commit message: `chore(release): vX.Y.Z`
- Commit author defaults to:
  - `name = "brel[bot]"`
  - `email = "brel[bot]@users.noreply.github.com"`
- Push strategy: `--force-with-lease` to `origin`.

For PRs:

- `brel` uses `gh pr list` to find an open managed release PR.
- If found, it updates that PR (continuity wins over recomputing branch name).
- If not found, it creates a new PR.

## PR Body Templates

If `release_pr.pr_template_file` is set, `brel` renders that Handlebars template.

Available variables:

- `version`
- `base_branch`
- `release_branch`
- `commits` (array of `{ sha_short, subject }`)

Important: include this marker in your template so future runs can detect and update the same PR:

```html
<!-- managed-by: brel -->
```

If rendering fails, `brel release-pr` exits with an error.

## Typical Usage

Generate workflow once:

```bash
brel init --yes
```

Run release locally:

```bash
GH_TOKEN=... brel release-pr
```

Run with explicit config:

```bash
brel release-pr --config ./configs/release.toml
```
