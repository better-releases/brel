# managed-by: brel
name: Release PR

on:
  workflow_dispatch:
  push:
    branches:
      - {{default_branch}}
{{#if tagging_enabled}}
  pull_request:
    types:
      - closed
    branches:
      - {{default_branch}}
{{/if}}

permissions:
  contents: write
  pull-requests: write

jobs:
  release-pr:
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install brel (latest release)
        env:
          BREL_RELEASE_REPO: better-releases/brel
        run: |
          set -euo pipefail

          release_json="$(curl -fsSL "https://api.github.com/repos/${BREL_RELEASE_REPO}/releases/latest")"
          asset_name="$(echo "${release_json}" | jq -r '[.assets[] | select(.name | test("x86_64-unknown-linux-musl\\.(tar\\.(gz|xz)|zip)$"))][0].name // empty')"
          asset_url="$(echo "${release_json}" | jq -r '[.assets[] | select(.name | test("x86_64-unknown-linux-musl\\.(tar\\.(gz|xz)|zip)$"))][0].browser_download_url // empty')"

          if [ -z "${asset_name}" ] || [ -z "${asset_url}" ]; then
            echo "Could not find a Linux x86_64 archive asset (.tar.gz, .tar.xz, .zip) for latest brel release." >&2
            exit 1
          fi

          archive_path="${RUNNER_TEMP}/${asset_name}"
          curl -fsSL "${asset_url}" -o "${archive_path}"

          case "${asset_name}" in
            *.tar.gz|*.tgz|*.tar.xz)
              tar -xaf "${archive_path}" -C "${RUNNER_TEMP}"
              ;;
            *.zip)
              unzip -q "${archive_path}" -d "${RUNNER_TEMP}"
              ;;
            *)
              echo "Unsupported brel archive format: ${asset_name}" >&2
              exit 1
              ;;
          esac

          brel_bin="$(find "${RUNNER_TEMP}" -type f -name brel | head -n1)"
          if [ -z "${brel_bin}" ]; then
            echo "Unable to locate brel binary after extraction." >&2
            exit 1
          fi

          chmod +x "${brel_bin}"
          cp "${brel_bin}" "${RUNNER_TEMP}/brel"
          echo "${RUNNER_TEMP}" >> "${GITHUB_PATH}"

      - name: Compute next version
        id: next-version
        run: |
          set -euo pipefail
          next_version="$({{next_version_command}})"
          echo "version=${next_version}" >> "${GITHUB_OUTPUT}"

{{#if changelog_enabled}}
      - name: Generate changelog
        if: {{next_version_non_empty_expr}}
        uses: orhun/git-cliff-action@v4
        with:
          config: cliff.toml
          args: --unreleased --tag {{next_version_tag_output_expr}} --prepend {{changelog_output_file}}

{{/if}}
      - name: Generate release PR
        env:
          GH_TOKEN: {{github_token_expr}}
        run: {{release_pr_command}}
{{#if tagging_enabled}}

  release-tag:
    if: github.event_name == 'pull_request' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Validate tag push token
        env:
          BREL_TAG_PUSH_TOKEN: {{tagging_push_token_expr}}
        run: |
          set -euo pipefail
          if [ -z "${BREL_TAG_PUSH_TOKEN}" ]; then
            echo "Missing repository secret BREL_TAG_PUSH_TOKEN." >&2
            echo "Use a PAT with Contents: Read and write to push release tags from this workflow." >&2
            echo "GITHUB_TOKEN tag pushes do not trigger downstream tag-push workflows." >&2
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: {{tagging_push_token_expr}}

      - name: Create release tag
        run: |
          set -euo pipefail

          pr_title="$(jq -r '.pull_request.title // ""' "${GITHUB_EVENT_PATH}")"
          pr_body="$(jq -r '.pull_request.body // ""' "${GITHUB_EVENT_PATH}")"
          merge_commit_sha="$(jq -r '.pull_request.merge_commit_sha // ""' "${GITHUB_EVENT_PATH}")"

          if ! printf '%s' "${pr_body}" | grep -Fq '<!-- managed-by: brel -->'; then
            echo "PR is not managed by brel. Skipping tag creation."
            exit 0
          fi

          tag="$(printf '%s' "${pr_title}" | sed -nE 's/^Release (.+)$/\1/p')"
          if [ -z "${tag}" ]; then
            echo "PR title does not match expected release format. Skipping tag creation."
            exit 0
          fi

          prefix={{tagging_template_prefix_shell}}
          suffix={{tagging_template_suffix_shell}}

          if [ -n "${prefix}" ] && [[ "${tag}" != "${prefix}"* ]]; then
            echo "PR title tag does not match configured tag template. Skipping tag creation."
            exit 0
          fi

          candidate="${tag:${#prefix}}"
          if [ -n "${suffix}" ]; then
            if [[ "${candidate}" != *"${suffix}" ]]; then
              echo "PR title tag does not match configured tag template. Skipping tag creation."
              exit 0
            fi
            if [ "${#candidate}" -lt "${#suffix}" ]; then
              echo "PR title tag does not match configured tag template. Skipping tag creation."
              exit 0
            fi
            version="${candidate:0:${#candidate}-${#suffix}}"
          else
            version="${candidate}"
          fi

          if ! printf '%s' "${version}" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "PR title tag does not contain a stable semver. Skipping tag creation."
            exit 0
          fi

          expected_tag="${prefix}${version}${suffix}"
          if [ "${expected_tag}" != "${tag}" ]; then
            echo "PR title tag does not match configured tag template. Skipping tag creation."
            exit 0
          fi

          if [ -z "${merge_commit_sha}" ]; then
            echo "Missing merge commit SHA. Skipping tag creation."
            exit 0
          fi

          git fetch --tags origin
          if git rev-parse --verify --quiet "refs/tags/${tag}" >/dev/null; then
            echo "Tag ${tag} already exists. Skipping."
            exit 0
          fi

          git tag "${tag}" "${merge_commit_sha}"
          git push origin "refs/tags/${tag}"
          echo "Created and pushed tag ${tag} at ${merge_commit_sha}."
{{/if}}
